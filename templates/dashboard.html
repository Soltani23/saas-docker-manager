{% extends "base.html" %}

{% block title %}Dashboard - {{ user.username }}{% endblock %}

{% block content %}
<div class="dashboard">
    <header class="dashboard-header">
        <div>
            <h1>Welcome, {{ user.username }}! ðŸ‘‹</h1>
            <p class="subtitle">Manage your Docker containers</p>
        </div>
        <div class="header-actions">
            <button class="btn btn-primary" onclick="createContainer()">+ Create Container</button>
            <button class="btn btn-secondary" onclick="refreshContainers()">ðŸ”„ Refresh</button>
            <a href="{{ url_for('logout') }}" class="btn btn-outline">Logout</a>
        </div>
    </header>
    
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value" id="total-containers">{{ containers|length }}</div>
            <div class="stat-label">Total Containers</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="running-containers">
                {{ containers|selectattr('status', 'equalto', 'running')|list|length }}
            </div>
            <div class="stat-label">Running</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="stopped-containers">
                {{ containers|selectattr('status', 'equalto', 'exited')|list|length }}
            </div>
            <div class="stat-label">Stopped</div>
        </div>
    </div>
    
    <div class="containers-section">
        <h2>Your Containers</h2>
        
        <div id="containers-grid" class="containers-grid">
            {% if containers %}
                {% for container in containers %}
                <div class="container-card" data-container-id="{{ container.id }}">
                    <div class="container-header">
                        <h3>{{ container.name }}</h3>
                        <span class="status-badge status-{{ container.status }}">
                            {{ container.status }}
                        </span>
                    </div>
                    
                    <div class="container-details">
                        <p><strong>Port:</strong> {{ container.port }}</p>
                        <p><strong>URL:</strong> <a href="http://localhost:{{ container.port }}" target="_blank">http://localhost:{{ container.port }}</a></p>
                        <p><strong>ID:</strong> <code>{{ container.container_id[:12] }}</code></p>
                    </div>
                    
                    <div class="container-actions">
                        {% if container.status == 'running' %}
                        <button class="btn btn-sm btn-warning" onclick="stopContainer({{ container.id }})">Stop</button>
                        {% else %}
                        <button class="btn btn-sm btn-success" onclick="startContainer({{ container.id }})">Start</button>
                        {% endif %}
                        <button class="btn btn-sm btn-danger" onclick="deleteContainer({{ container.id }})">Delete</button>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <p>No containers yet. Create your first container to get started!</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="loading-overlay" style="display: none;">
    <div class="spinner"></div>
    <p>Processing...</p>
</div>

<script>
// API functions
async function createContainer() {
    const name = prompt('Enter container name (or leave empty for auto-generated):');
    
    showLoading();
    
    try {
        const response = await fetch('/api/containers/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: name || undefined })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`Container created successfully!\nName: ${data.container.name}\nPort: ${data.container.port}\nURL: ${data.container.url}`);
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Failed to create container: ' + error.message);
    } finally {
        hideLoading();
    }
}

async function startContainer(id) {
    showLoading();
    
    try {
        const response = await fetch(`/api/containers/${id}/start`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Container started successfully!');
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to start container'));
        }
    } catch (error) {
        alert('Failed to start container: ' + error.message);
    } finally {
        hideLoading();
    }
}

async function stopContainer(id) {
    showLoading();
    
    try {
        const response = await fetch(`/api/containers/${id}/stop`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Container stopped successfully!');
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to stop container'));
        }
    } catch (error) {
        alert('Failed to stop container: ' + error.message);
    } finally {
        hideLoading();
    }
}

async function deleteContainer(id) {
    if (!confirm('Are you sure you want to delete this container? This action cannot be undone.')) {
        return;
    }
    
    showLoading();
    
    try {
        const response = await fetch(`/api/containers/${id}/delete`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Container deleted successfully!');
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to delete container'));
        }
    } catch (error) {
        alert('Failed to delete container: ' + error.message);
    } finally {
        hideLoading();
    }
}

function refreshContainers() {
    location.reload();
}

function showLoading() {
    document.getElementById('loading-overlay').style.display = 'flex';
}

function hideLoading() {
    document.getElementById('loading-overlay').style.display = 'none';
}
</script>
{% endblock %}
